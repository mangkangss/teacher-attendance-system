<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ระบบลงเวลาข้าราชการครู - Role Based Access</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(to right, #e3f2fd, #e8f5e9);
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 650px;
      text-align: center;
    }
    h1 { color: #2e7d32; margin-bottom: 20px; }
    input, button {
      width: 100%; padding: 12px; margin: 10px 0;
      font-size: 16px; border-radius: 8px; border: 1px solid #ccc;
    }
    button {
      background-color: #4caf50; color: white; border: none; cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover { background-color: #388e3c; }
    button.logout {
      background-color: #f44336;
    }
    button.logout:hover {
      background-color: #c62828;
    }
    .hidden { display: none; }
    .time-display {
      font-weight: bold;
      margin: 15px 0;
      color: #555;
    }
    ul {
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
      padding-left: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 10px;
    }
    .admin-section, .report-section {
      margin-top: 30px;
      text-align: left;
      border-top: 1px solid #ddd;
      padding-top: 20px;
    }
    .admin-section h2, .report-section h2 {
      color: #2e7d32;
      margin-bottom: 10px;
    }
    .teacher-list li {
      margin-bottom: 6px;
      cursor: pointer;
      color: #2e7d32;
    }
    .teacher-list li:hover {
      text-decoration: underline;
    }
    @media (max-width: 600px) {
      .container { padding: 20px; margin: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ระบบลงเวลาข้าราชการครู<br>โรงเรียนบ้านตะเคียนช่างเหล็ก</h1>

    <!-- Login -->
    <div id="login-section">
      <input type="email" id="username" placeholder="อีเมลผู้ใช้" autocomplete="username" />
      <input type="password" id="password" placeholder="รหัสผ่าน" autocomplete="current-password" />
      <button id="login-button">เข้าสู่ระบบ</button>
    </div>

    <!-- Attendance -->
    <div id="attendance-section" class="hidden">
      <p>ยินดีต้อนรับ, <span id="current-user"></span> (<span id="current-role"></span>)</p>
      <p class="time-display">เวลาปัจจุบัน: <span id="current-time"></span></p>
      <button id="check-in-button">✅ ลงเวลาเข้า</button>
      <button id="check-out-button">⏹️ ลงเวลาออก</button>

      <h3>ประวัติการลงเวลา</h3>
      <ul id="attendance-history"></ul>

      <button class="logout" id="logout-button">ออกจากระบบ</button>

      <!-- Admin only: Manage teachers -->
      <div id="admin-section" class="admin-section hidden">
        <h2>เพิ่มรายชื่อครู</h2>
        <input type="email" id="new-teacher-email" placeholder="อีเมลครู" />
        <input type="text" id="new-teacher-name" placeholder="ชื่อครู" />
        <select id="new-teacher-role" style="width: 100%; padding: 12px; margin-top: 10px; border-radius:8px; border:1px solid #ccc;">
          <option value="teacher" selected>ครูทั่วไป</option>
          <option value="admin">แอดมิน</option>
        </select>
        <button id="add-teacher-button">เพิ่มครู</button>

        <h2>รายชื่อครู</h2>
        <ul id="teacher-list" class="teacher-list"></ul>
      </div>

      <!-- Admin only: Report section -->
      <div id="report-section" class="report-section hidden">
        <h2>รายงานการลงเวลา (คลิกชื่อครูเพื่อดูรายงาน)</h2>
        <ul id="report-teacher-list" class="teacher-list"></ul>

        <h3 id="report-title"></h3>
        <ul id="report-attendance-history"></ul>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, getDoc, getDocs,
      addDoc, query, where, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBWUo6jf9n54L79Izza8ykPRA2FuBUrB1k",
      authDomain: "teacher-attendance-syste-2e38d.firebaseapp.com",
      projectId: "teacher-attendance-syste-2e38d",
      storageBucket: "teacher-attendance-syste-2e38d.firebasestorage.app",
      messagingSenderId: "991558014835",
      appId: "1:991558014835:web:6126c37c299962e9455706",
      measurementId: "G-2W4NNQVTKT"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const loginSection = document.getElementById("login-section");
    const attendanceSection = document.getElementById("attendance-section");
    const adminSection = document.getElementById("admin-section");
    const reportSection = document.getElementById("report-section");

    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("login-button");
    const logoutBtn = document.getElementById("logout-button");

    const currentUserSpan = document.getElementById("current-user");
    const currentRoleSpan = document.getElementById("current-role");
    const currentTimeSpan = document.getElementById("current-time");

    const checkInBtn = document.getElementById("check-in-button");
    const checkOutBtn = document.getElementById("check-out-button");

    const attendanceHistory = document.getElementById("attendance-history");

    const newTeacherEmailInput = document.getElementById("new-teacher-email");
    const newTeacherNameInput = document.getElementById("new-teacher-name");
    const newTeacherRoleSelect = document.getElementById("new-teacher-role");
    const addTeacherBtn = document.getElementById("add-teacher-button");

    const teacherList = document.getElementById("teacher-list");
    const reportTeacherList = document.getElementById("report-teacher-list");
    const reportTitle = document.getElementById("report-title");
    const reportAttendanceHistory = document.getElementById("report-attendance-history");

    let currentUserEmail = "";
    let currentUserName = "";
    let currentUserRole = "teacher";

    // Update current time every second
    function updateTime() {
      const now = new Date();
      currentTimeSpan.textContent = now.toLocaleTimeString("th-TH");
    }
    setInterval(updateTime, 1000);
    updateTime();

    // Fetch user role & name from Firestore
    async function fetchUserData(email) {
      const docRef = doc(db, "teachers", email);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        return {
          name: data.name || email,
          role: data.role || "teacher"
        };
      }
      return { name: email, role: "teacher" };
    }

    // Load attendance history for current user or selected user
    async function loadHistory(email, targetList) {
      targetList.innerHTML = "";
      const q = query(
        collection(db, "attendance"),
        where("email", "==", email),
        orderBy("timestamp", "desc")
      );
      const querySnapshot = await getDocs(q);
      if (querySnapshot.empty) {
        const li = document.createElement("li");
        li.textContent = "ไม่มีข้อมูลการลงเวลา";
        targetList.appendChild(li);
        return;
      }
      querySnapshot.forEach(docSnap => {
        const d = docSnap.data();
        const time = d.timestamp?.toDate?.().toLocaleString("th-TH") || "-";
        const li = document.createElement("li");
        li.textContent = `${d.name || d.email} ${d.type} เวลา ${time}`;
        targetList.appendChild(li);
      });
    }

    // Load list of teachers for admin
    async function loadTeacherList() {
      teacherList.innerHTML = "";
      reportTeacherList.innerHTML = "";
      const snapshot = await getDocs(collection(db, "teachers"));
      if (snapshot.empty) {
        teacherList.innerHTML = "<li>ไม่มีรายชื่อครู</li>";
        reportTeacherList.innerHTML = "<li>ไม่มีรายชื่อครู</li>";
        return;
      }
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const liAdmin = document.createElement("li");
        liAdmin.textContent = `${data.name} (${docSnap.id})`;
        teacherList.appendChild(liAdmin);

        const liReport = document.createElement("li");
        liReport.textContent = `${data.name} (${docSnap.id})`;
        liReport.style.cursor = "pointer";
        liReport.addEventListener("click", () => {
          reportTitle.textContent = `รายงานการลงเวลา: ${data.name} (${docSnap.id})`;
          loadHistory(docSnap.id, reportAttendanceHistory);
        });
        reportTeacherList.appendChild(liReport);
      });
    }

    // Log attendance (check-in / check-out)
    async function logAttendance(type) {
      try {
        await addDoc(collection(db, "attendance"), {
          email: currentUserEmail,
          name: currentUserName,
          type,
          timestamp: serverTimestamp()
        });
        alert(`ลงเวลา${type} สำเร็จ`);
        await loadHistory(currentUserEmail, attendanceHistory);
      } catch (error) {
        alert("เกิดข้อผิดพลาด: " + error.message);
      }
    }

    // Login button event
    loginBtn.addEventListener("click", async () => {
      const email = usernameInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        alert("กรุณากรอกอีเมลและรหัสผ่าน");
        return;
      }
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        currentUserEmail = user.email;

        // ดึงข้อมูลชื่อและ role
        const userData = await fetchUserData(currentUserEmail);
        currentUserName = userData.name;
        currentUserRole = userData.role;

        // แสดงข้อมูลผู้ใช้และ role
        currentUserSpan.textContent = currentUserName;
        currentRoleSpan.textContent = currentUserRole === "admin" ? "แอดมิน" : "ครูทั่วไป";

        // แสดง/ซ่อน ส่วนของแอดมิน
        if (currentUserRole === "admin") {
          adminSection.classList.remove("hidden");
          reportSection.classList.remove("hidden");
          await loadTeacherList();
        } else {
          adminSection.classList.add("hidden");
          reportSection.classList.add("hidden");
        }

        // แสดงหน้าลงเวลาและซ่อนล็อกอิน
        loginSection.classList.add("hidden");
        attendanceSection.classList.remove("hidden");

        // โหลดประวัติของผู้ใช้
        await loadHistory(currentUserEmail, attendanceHistory);

        // ล้างข้อมูล input
        usernameInput.value = "";
        passwordInput.value = "";

      } catch (error) {
        alert("เข้าสู่ระบบไม่สำเร็จ: " + error.message);
      }
    });

    // Logout button event
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      currentUserEmail = "";
      currentUserName = "";
      currentUserRole = "teacher";
      adminSection.classList.add("hidden");
      reportSection.classList.add("hidden");
      attendanceSection.classList.add("hidden");
      loginSection.classList.remove("hidden");
      attendanceHistory.innerHTML = "";
      teacherList.innerHTML = "";
      reportTeacherList.innerHTML = "";
      reportAttendanceHistory.innerHTML = "";
      reportTitle.textContent = "";
    });

    // Check-in/out button events
    checkInBtn.addEventListener("click", () => logAttendance("เช็คอิน"));
    checkOutBtn.addEventListener("click", () => logAttendance("เช็คเอาท์"));

    // Add new teacher button (admin only)
    addTeacherBtn.addEventListener("click", async () => {
      if (currentUserRole !== "admin") {
        alert("สิทธิ์ไม่เพียงพอ");
        return;
      }
      const email = newTeacherEmailInput.value.trim();
      const name = newTeacherNameInput.value.trim();
      const role = newTeacherRoleSelect.value;
      if (!email || !name) {
        alert("กรุณากรอกอีเมลและชื่อครูให้ครบถ้วน");
        return;
      }
      try {
        await setDoc(doc(db, "teachers", email), { name, role });
        alert("เพิ่มครูเรียบร้อยแล้ว");
        newTeacherEmailInput.value = "";
        newTeacherNameInput.value = "";
        newTeacherRoleSelect.value = "teacher";
        await loadTeacherList();
      } catch (err) {
        alert("เกิดข้อผิดพลาดในการเพิ่มครู: " + err.message);
      }
    });

    // Auto logout if user is not logged in
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        logoutBtn.click();
      }
    });

  </script>
</body>
</html>
